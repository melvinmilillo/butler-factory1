name: üöÄ Content Factory (Diagnostic Mode)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: '–°–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç–µ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞ 1 –∏—Ç–µ—Ä–∞—Ü–∏—é?'
        required: true
        default: '50'
      iterations:
        description: '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–≤–µ–π–µ—Ä?'
        required: true
        default: '10'

jobs:
  build:
    permissions:
      contents: write
      
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: npm install

      - name: üè≠ Run Content Factory Conveyor
        id: factory_run
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          
          ALL_NEW_URLS=""

          for i in $(seq 1 ${{ github.event.inputs.iterations }})
          do
            echo "--- –ö–û–ù–í–ï–ô–ï–†: –ó–∞–ø—É—Å–∫ –∏—Ç–µ—Ä–∞—Ü–∏–∏ $i –∏–∑ ${{ github.event.inputs.iterations }} ---"
            
            commit_before=$(git rev-parse HEAD)
            
            npm run factory
            
            # --- –ù–ê–ß–ê–õ–û –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–û–ì–û –ë–õ–û–ö–ê ---
            echo "--- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Git ---"
            echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–æ–≤..."
            git status

            if [[ -z $(git status --porcelain) ]]; then
              echo "‚úÖ –ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ó–∞–≤–µ—Ä—à–∞—é –∏—Ç–µ—Ä–∞—Ü–∏—é."
              continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            fi
            
            echo "üî• –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –î–æ–±–∞–≤–ª—è—é –≤ –∏–Ω–¥–µ–∫—Å..."
            git add .

            echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ 'git add':"
            git status

            echo "–í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–º–∏—Ç..."
            git commit -m "üöÄ –ê–≤—Ç–æ-–ø—É–±–ª–∏–∫–∞—Ü–∏—è: –ø–∞—á–∫–∞ —Å—Ç–∞—Ç–µ–π ‚Ññ$i"

            echo "–í—ã–ø–æ–ª–Ω—è—é push..."
            git push
            # --- –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–û–ì–û –ë–õ–û–ö–ê ---
            
            commit_after=$(git rev-parse HEAD)

            NEW_FILES=$(git diff --name-only $commit_before $commit_after -- 'src/content/posts/*.md')
            
            for file in $NEW_FILES; do
              slug=$(basename $file .md)
              url="https://butlerspb-blog.netlify.app/blog/${slug}/"
              ALL_NEW_URLS="${ALL_NEW_URLS}${url}\n"
            done

            echo "‚úÖ –ü–∞—á–∫–∞ $i —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞."
          done

          echo "urllist<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALL_NEW_URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üì¢ Notify IndexNow
        if: steps.factory_run.outputs.urllist
        run: |
          echo "–û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ IndexNow..."
          API_KEY="d1b055ab1eb146d892169bbb2c96550e"
          HOST="butlerspb-blog.netlify.app"
          
          JSON_PAYLOAD=$(jq -n \
                          --arg host "$HOST" \
                          --arg key "$API_KEY" \
                          --argjson urls "$(echo '${{ steps.factory_run.outputs.urllist }}' | jq -R . | jq -s .)" \
                          '{host: $host, key: $key, urlList: $urls}')

          curl -X POST "https://yandex.com/indexnow" \
               -H "Content-Type: application/json; charset=utf-8" \
               -d "$JSON_PAYLOAD"
          echo -e "\n–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."```
</details>

**–ß—Ç–æ –º—ã –∏–∑–º–µ–Ω–∏–ª–∏:**
*   –Ø —É–±—Ä–∞–ª –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é `if/else`, —á—Ç–æ–±—ã —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É.
*   –Ø –¥–æ–±–∞–≤–∏–ª —è–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã `git status` –¥–æ –∏ –ø–æ—Å–ª–µ `git add .`.
*   –Ø –∏–∑–º–µ–Ω–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ü–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏.

**–í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:**
1.  –ó–∞–º–µ–Ω–∏—Ç–µ –∫–æ–¥ –≤ —Ñ–∞–π–ª–µ `.github/workflows/factory.yml`.
2.  –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–æ—Ä–∫—Ñ–ª–æ—É –µ—â–µ —Ä–∞–∑ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ "1 —Å—Ç–∞—Ç—å—è, 1 –∏—Ç–µ—Ä–∞—Ü–∏—è".
3.  **–ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –ª–æ–≥ —ç—Ç–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.**

–¢–µ–ø–µ—Ä—å –ª–æ–≥ –±—É–¥–µ—Ç –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–º. –ú—ã —É–≤–∏–¥–∏–º, –≤–∏–¥–∏—Ç –ª–∏ `git` –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –¥–æ–±–∞–≤–ª—è–µ—Ç –ª–∏ –æ–Ω –∏—Ö –≤ "–∏–Ω–¥–µ–∫—Å" –¥–ª—è –∫–æ–º–º–∏—Ç–∞, –∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –∫–æ–º–∞–Ω–¥–æ–π `push`. –≠—Ç–æ –¥–∞—Å—Ç –Ω–∞–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –ú—ã –Ω–∞ –ø–æ—Ä–æ–≥–µ —Ä–∞–∑–≥–∞–¥–∫–∏.
