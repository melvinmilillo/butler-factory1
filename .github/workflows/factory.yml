name: üöÄ Content Factory (Synchronized Strike)

on:
  workflow_dispatch:
    inputs:
      batch_size_per_thread:
        description: '–°–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç–µ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ö–ê–ñ–î–´–ú –ø–æ—Ç–æ–∫–æ–º?'
        required: true
        default: '10'
      threads:
        description: '–°–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–ø—É—Å—Ç–∏—Ç—å –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û (1-20)?'
        required: true
        default: '5'

jobs:
  # --- –ó–ê–î–ê–ß–ê ‚Ññ1: –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø ---
  generate_and_publish:
    permissions:
      contents: write
      
    runs-on: ubuntu-latest
    
    outputs:
      # –ú—ã –±—É–¥–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ URL —Å–æ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤ –∑–¥–µ—Å—å
      all_new_urls: ${{ steps.factory.outputs.urllist }}
      
    strategy:
      fail-fast: false
      matrix:
        thread: ${{ fromJson(format('[{0}]', range(1, github.event.inputs.threads + 1))) }}

    steps:
      - name: ‚¨áÔ∏è Checkout repo (Thread ${{ matrix.thread }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ‚öôÔ∏è Setup Node.js (Thread ${{ matrix.thread }})
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies (Thread ${{ matrix.thread }})
        run: npm install

      - name: üîë Set API Key for Thread ${{ matrix.thread }}
        id: set_key
        # ... (—ç—Ç–æ—Ç —à–∞–≥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)

      - name: üè≠ Run Factory & Publish (Thread ${{ matrix.thread }})
        id: factory # –î–∞–µ–º —ç—Ç–æ–º—É —à–∞–≥—É ID
        env:
          # ... (—ç—Ç–æ—Ç env –±–ª–æ–∫ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
        run: |
          # ... (–≤–µ—Å—å –∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ git push –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ)
          
          # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ–±–∏—Ä–∞–µ–º URL –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ –°–õ–ï–î–£–Æ–©–£–Æ –ó–ê–î–ê–ß–£ ---
          URL_LIST=""
          # ... (–ª–æ–≥–∏–∫–∞ —Å git diff –∏ —Ü–∏–∫–ª–æ–º for –¥–ª—è —Å–±–æ—Ä–∞ URL)
          
          echo "urllist<<EOF" >> $GITHUB_OUTPUT
          echo -e "$URL_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # --- –ó–ê–î–ê–ß–ê ‚Ññ2: –û–ñ–ò–î–ê–ù–ò–ï –ò –û–¢–ü–†–ê–í–ö–ê –í INDEXNOW ---
  notify:
    # –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∂–¥–µ—Ç, –ø–æ–∫–∞ –í–°–ï –∑–∞–¥–∞—á–∏ –∏–∑ 'generate_and_publish' –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
    needs: generate_and_publish
    # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
    if: always() && needs.generate_and_publish.outputs.all_new_urls

    runs-on: ubuntu-latest
    steps:
      - name: ‚è∏Ô∏è Tactical Pause for Netlify Build
        run: |
          echo "–î–µ–ª–∞—é —Ç–∞–∫—Ç–∏—á–µ—Å–∫—É—é –ø–∞—É–∑—É –Ω–∞ 90 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –¥–∞—Ç—å Netlify –≤—Ä–µ–º—è –Ω–∞ —Å–±–æ—Ä–∫—É —Å–∞–π—Ç–∞..."
          sleep 90
          echo "–ü–∞—É–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ IndexNow."

      - name: üì¢ Notify IndexNow (Yandex & Bing)
        run: |
          echo "–û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ IndexNow..."
          API_KEY="d1b055ab1eb146d892169bbb2c96550e"
          HOST="butlerspb-blog.netlify.app"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ URL –∏–∑ –í–´–•–û–î–ù–´–• –î–ê–ù–ù–´–• –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏
          URL_LIST_STRING='${{ needs.generate_and_publish.outputs.all_new_urls }}'
          
          if [[ -z "$URL_LIST_STRING" ]]; then
            echo "‚úÖ –ù–æ–≤—ã—Ö URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
            exit 0
          fi

          JSON_PAYLOAD=$(jq -n \
                          --arg host "$HOST" \
                          --arg key "$API_KEY" \
                          --arg urls_string "$URL_LIST_STRING" \
                          '{host: $host, key: $key, urlList: ($urls_string | split("\n") | map(select(length > 0)))}'
                          )
          
          echo "--- –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ---"
          echo "$JSON_PAYLOAD"
          
          curl -X POST "https://yandex.com/indexnow" -H "Content-Type: application/json; charset=utf-8" -d "$JSON_PAYLOAD"
          curl -X POST "https://www.bing.com/indexnow" -H "Content-Type: application/json; charset=utf-8" -d "$JSON_PAYLOAD"
          echo -e "\n–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã."
