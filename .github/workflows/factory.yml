name: üöÄ Content Factory (IndexNow Ready)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: '–°–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç–µ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞ 1 –∏—Ç–µ—Ä–∞—Ü–∏—é?'
        required: true
        default: '50'
      iterations:
        description: '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–≤–µ–π–µ—Ä?'
        required: true
        default: '10'

jobs:
  build:
    permissions:
      contents: write
      
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4
        with:
          # –í–ê–ñ–ù–û: –ù–∞–º –Ω—É–∂–Ω–∞ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          fetch-depth: 0 

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: npm install

      - name: üè≠ Run Content Factory Conveyor
        id: factory_run # <-- –î–∞–µ–º —ç—Ç–æ–º—É —à–∞–≥—É ID, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∞–ª—å—à–µ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          
          # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –í–°–ï–• –Ω–æ–≤—ã—Ö URL –∑–∞ –≤–µ—Å—å –∑–∞–ø—É—Å–∫
          ALL_NEW_URLS=""

          for i in $(seq 1 ${{ github.event.inputs.iterations }})
          do
            echo "--- –ö–û–ù–í–ï–ô–ï–†: –ó–∞–ø—É—Å–∫ –∏—Ç–µ—Ä–∞—Ü–∏–∏ $i –∏–∑ ${{ github.event.inputs.iterations }} ---"
            
            commit_before=$(git rev-parse HEAD)
            
            npm run factory
            
            if [[ -z $(git status --porcelain) ]]; then
              echo "‚úÖ –ù–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –≤ —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–µ—Ç. –†–∞–±–æ—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
              break
            fi

            echo "üî• –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –û—Ç–ø—Ä–∞–≤–ª—è—é –ø–∞—á–∫—É $i..."
            # –î–æ–±–∞–≤–ª—è–µ–º --atomic —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ push –ø—Ä–æ–π–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ
            git push --atomic origin main
            
            commit_after=$(git rev-parse HEAD)

            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            NEW_FILES=$(git diff --name-only $commit_before $commit_after -- 'src/content/posts/*.md')
            
            for file in $NEW_FILES; do
              slug=$(basename $file .md)
              url="https://butlerspb-blog.netlify.app/blog/${slug}/"
              ALL_NEW_URLS="${ALL_NEW_URLS}${url}\n"
            done

            echo "‚úÖ –ü–∞—á–∫–∞ $i —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é."
          done

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ URL –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          echo "urllist<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ALL_NEW_URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- –í–û–¢ –ù–û–í–´–ô –®–ê–ì, –ö–û–¢–û–†–´–ô –ú–´ –î–û–ë–ê–í–õ–Ø–ï–ú –í –ö–û–ù–ï–¶ ---
      - name: üì¢ Notify IndexNow
        # –≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–æ–≤—ã–µ URL
        if: steps.factory_run.outputs.urllist
        run: |
          echo "–û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ IndexNow..."
          # –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –∫–ª—é—á
          API_KEY="d1b055ab1eb146d892169bbb2c96550e"
          HOST="butlerspb-blog.netlify.app"
          
          # –°–æ–∑–¥–∞–µ–º JSON-—Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
          JSON_PAYLOAD=$(jq -n \
                          --arg host "$HOST" \
                          --arg key "$API_KEY" \
                          --argjson urls "$(echo '${{ steps.factory_run.outputs.urllist }}' | jq -R . | jq -s .)" \
                          '{host: $host, key: $key, urlList: $urls}')

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
          curl -X POST "https://yandex.com/indexnow" \
               -H "Content-Type: application/json; charset=utf-8" \
               -d "$JSON_PAYLOAD"
          echo -e "\n–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
